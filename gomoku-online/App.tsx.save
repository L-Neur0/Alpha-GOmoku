zimport React, { useState, useEffect } from 'react';
import { AppState, GameMode, GameConfig, ScoreEntry } from './types';
import { Button } from './components/Button';
import { SetupForm } from './components/SetupForm';
import { Game } from './components/Game';
import { Scoreboard } from './components/Scoreboard';

const STORAGE_KEY = 'gomoku_scores';

export default function App() {
    const [appState, setAppState] = useState<AppState>(AppState.MENU);
    const [gameMode, setGameMode] = useState<GameMode>(GameMode.STANDARD);
    const [config, setConfig] = useState<GameConfig | null>(null);
    const [scores, setScores] = useState<Record<string, number>>({});

    // Load scores on mount
    useEffect(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                setScores(JSON.parse(saved));
            } catch (e) {
                console.error("Failed to load scores", e);
            }
        }
    }, []);

    const saveScore = (winnerName: string) => {
        setScores(prev => {
            const newScores = { ...prev };
            newScores[winnerName] = (newScores[winnerName] || 0) + 1;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(newScores));
            return newScores;
        });
    };

    const handleModeSelect = (mode: GameMode) => {
        setGameMode(mode);
        setAppState(AppState.SETUP);
    };

    const handleGameStart = (setupData: { cols: number; rows: number; playerAName: string; playerBName: string }) => {
        setConfig({
            ...setupData,
            canRemove: gameMode === GameMode.ADJUSTABLE_REMOVE
        });
        setAppState(AppState.PLAYING);
    };

    const handleGameEnd = (winner: string | null) => {
        if (winner) {
            saveScore(winner);
        }
        setAppState(AppState.MENU);
    };

    const renderMenu = () => (
        <div className="flex flex-col items-center justify-center min-h-[80vh] space-y-8 p-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="text-center space-y-2">
                <div className="w-24 h-24 bg-wood-200 rounded-full mx-auto shadow-lg flex items-center justify-center border-4 border-wood-800 mb-4">
                   <div className="w-16 h-16 bg-stone-900 rounded-full shadow-stone-black"></div> 
                </div>
                <h1 className="text-6xl font-serif font-bold text-stone-800 tracking-tight">Gomoku</h1>
                <p className="text-stone-500 text-lg">Master the five-in-a-row strategy</p>
            </div>

            <div className="flex flex-col gap-4 w-full max-w-sm">
                <Button onClick={() => handleModeSelect(GameMode.STANDARD)} variant="wood">
                    Play Standard Game (15x15)
                </Button>
                <Button onClick={() => handleModeSelect(GameMode.AI)} variant="wood">
                    Play vs AI (8x8 Demo)
                </Button>
                <Button onClick={() => handleModeSelect(GameMode.ADJUSTABLE)}>
                    Custom Board Size
                </Button>
                <Button onClick={() => handleModeSelect(GameMode.ADJUSTABLE_REMOVE)}>
                    Custom Size + Undo
                </Button>
                <Button onClick={() => setAppState(AppState.SCOREBOARD)} variant="secondary">
                    Hall of Fame
                </Button>
            </div>
        </div>
    );

    return (
        <div className="min-h-screen bg-stone-100 text-stone-900 font-sans selection:bg-wood-300 selection:text-wood-900">
            {/* Decorative Background Elements */}
            <div className="fixed inset-0 pointer-events-none overflow-hidden opacity-5 z-0">
                <div className="absolute -top-20 -left-20 w-96 h-96 bg-wood-800 rounded-full blur-3xl"></div>
                <div className="absolute top-1/3 right-0 w-64 h-64 bg-stone-900 rounded-full blur-3xl"></div>
                <div className="absolute -bottom-20 left-1/3 w-80 h-80 bg-wood-400 rounded-full blur-3xl"></div>
            </div>

            <div className="relative z-10 container mx-auto">
                {appState === AppState.MENU && renderMenu()}
                
                {appState === AppState.SETUP && (
                    <div className="min-h-screen flex items-center justify-center p-4 animate-in fade-in zoom-in-95 duration-300">
                        <SetupForm 
                            mode={gameMode} 
                            onStart={handleGameStart} 
                            onBack={() => setAppState(AppState.MENU)} 
                        />
                    </div>
                )}

                {appState === AppState.PLAYING && config && (
                    <div className="min-h-screen flex items-center justify-center animate-in fade-in duration-500">
                        <Game 
                            config={config} 
                            mode={gameMode}
                            onGameEnd={handleGameEnd} 
                            onExit={() => setAppState(AppState.MENU)} 
                        />
                    </div>
                )}

                {appState === AppState.SCOREBOARD && (
                    <div className="min-h-screen animate-in fade-in slide-in-from-right-8 duration-300">
                        <Scoreboard 
                            scores={scores} 
                            onBack={() => setAppState(AppState.MENU)} 
                        />
                    </div>
                )}
            </div>
        </div>
    );
}
